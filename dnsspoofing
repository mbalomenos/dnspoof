import os
import subprocess
import tkinter as tk
from tkinter import filedialog, messagebox, simpledialog, ttk
import netifaces
import nmap
import threading

class Tooltip:
    def __init__(self, widget, text):
        self.widget = widget
        self.text = text
        self.widget.bind("<Enter>", self.enter)
        self.widget.bind("<Leave>", self.leave)
        self.tooltip = None

    def enter(self, event=None):
        self.tooltip = tk.Toplevel(self.widget)
        x, y, _, _ = self.widget.bbox("insert")
        x_root, y_root = self.widget.winfo_rootx() + x + 25, self.widget.winfo_rooty() + y + 20
        self.tooltip.wm_overrideredirect(True)
        self.tooltip.wm_geometry(f"+{x_root}+{y_root}")
        label = tk.Label(self.tooltip, text=self.text, background="#ffffe0", relief="solid", borderwidth=1)
        label.pack(ipadx=1)

    def leave(self, event=None):
        if self.tooltip:
            self.tooltip.destroy()

class NmapScanWindow:
    def __init__(self, parent, ip_range):
        self.parent = parent
        self.ip_range = ip_range
        self.root = tk.Toplevel(parent)
        self.root.title("Nmap Scan Progress")

        self.progress_label = tk.Label(self.root, text="Scanning in progress...")
        self.progress_label.pack(padx=10, pady=5)

        self.progress_bar = ttk.Progressbar(self.root, orient="horizontal", length=200, mode="determinate")
        self.progress_bar.pack(padx=10, pady=5)

        self.scan_result_text = tk.Text(self.root, height=15, width=50)
        self.scan_result_text.pack(padx=10, pady=5)

    def update_scan_progress(self, percent):
        self.progress_bar["value"] = percent
        self.root.update()

    def update_scan_results(self, results):
        self.scan_result_text.insert(tk.END, results)
        self.scan_result_text.see(tk.END)

    def close_window(self):
        self.root.destroy()

class DNS_Spoofing_Tool:
    def __init__(self, root):
        self.root = root
        self.root.title("DNS Spoofing Tool")

        # Label and entry for Parrot Linux IP
        self.parrot_ip_label = tk.Label(root, text="Your IP:")
        self.parrot_ip_label.grid(row=0, column=0, padx=10, pady=5)
        self.parrot_ip_entry = tk.Entry(root)
        self.parrot_ip_entry.grid(row=0, column=1, padx=10, pady=5)
        Tooltip(self.parrot_ip_entry, "Your Parrot Linux IP address.")

        # Label and entry for target URL
        self.target_url_label = tk.Label(root, text="Target URL:")
        self.target_url_label.grid(row=1, column=0, padx=10, pady=5)
        self.target_url_entry = tk.Entry(root)
        self.target_url_entry.grid(row=1, column=1, padx=10, pady=5)
        Tooltip(self.target_url_entry, "Enter the URL of the website you want to clone.")

        # Button to scan for available target IPs
        self.scan_button = tk.Button(root, text="Scan for Target IPs", command=self.scan_ips)
        self.scan_button.grid(row=0, column=2, padx=10, pady=5)
        Tooltip(self.scan_button, "Scan for available target IP addresses in the network.")

        # Dropdown for network interface
        self.interface_label = tk.Label(root, text="Network Interface:")
        self.interface_label.grid(row=2, column=0, padx=10, pady=5)
        self.interfaces = netifaces.interfaces()
        self.interface_var = tk.StringVar(root)
        self.interface_var.set(self.interfaces[0])  # Set default value
        self.interface_dropdown = tk.OptionMenu(root, self.interface_var, *self.interfaces)
        self.interface_dropdown.grid(row=2, column=1, padx=10, pady=5)
        Tooltip(self.interface_dropdown, "Select the network interface to use for DNS spoofing.")

        # Label to display available target IPs
        self.target_ips_label = tk.Label(root, text="Available Target IPs:")
        self.target_ips_label.grid(row=3, column=0, padx=10, pady=5)
        self.target_ips_text = tk.Text(root, height=5, width=50)
        self.target_ips_text.grid(row=3, column=1, columnspan=2, padx=10, pady=5)
        Tooltip(self.target_ips_text, "List of available target IP addresses found in the network.")

        # Button to start DNS spoofing
        self.start_button = tk.Button(root, text="Start DNS Spoofing", command=self.start_dns_spoofing)
        self.start_button.grid(row=5, column=0, columnspan=2, padx=10, pady=5)
        Tooltip(self.start_button, "Start DNS spoofing with the specified configuration.")

        # Get and display Parrot Linux IP
        self.parrot_ip_entry.insert(0, self.get_parrot_ip())

    def get_parrot_ip(self):
        # Get IP address of the Parrot Linux machine
        for interface in netifaces.interfaces():
            if interface != "lo":
                return netifaces.ifaddresses(interface)[netifaces.AF_INET][0]['addr']

    def scan_ips(self):
        try:
            # Retrieve IP range from user input
            ip_range_input = simpledialog.askstring("IP Range", "Enter IP range (e.g., 192.168.0.0/24):")
            if ip_range_input:
                self.scan_window = NmapScanWindow(self.root, ip_range_input)
                # Perform a network scan to identify other devices on the network
                nm = nmap.PortScanner()

                # Callback function to update UI with scan results
                def callback_result(host, scan_result):
                    manufacturer = scan_result['vendor'].get('mac') if 'vendor' in scan_result else "Unknown"
                    result = f"IP: {host}, Manufacturer: {manufacturer}\n"
                    self.scan_window.update_scan_results(result)

                # Callback function to update UI with scan progress
                def callback_progress(current, total):
                    percent = int((current / total) * 100)
                    self.scan_window.update_scan_progress(percent)

                # Scan hosts in the given IP range
                nm.scan(hosts=ip_range_input, arguments='-sn', callback=callback_result, callback_progress=callback_progress)

                # Add handling for Nmap errors
                messagebox.showinfo("Scan Completed", "IP scan completed successfully!")

        except nmap.PortScannerError as e:
            messagebox.showerror("Nmap Error", f"Nmap encountered an error: {e}")
        except Exception as e:
            messagebox.showerror("Error", f"An error occurred while scanning IPs: {str(e)}")

    # Other methods omitted for brevity...

if __name__ == "__main__":
    root = tk.Tk()
    dns_spoofing_tool = DNS_Spoofing_Tool(root)
    root.mainloop()
